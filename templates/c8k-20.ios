interface GigabitEthernet1
 description first outside interface / public ip address
 ip address dhcp
 no shutdown
!
interface GigabitEthernet2
 description inside interface
 ip address dhcp
 no shutdown
!
interface GigabitEthernet3
 description second outside interface / public ip address
 ip address dhcp
 no shutdown
! 
crypto ikev2 proposal IKEv2-PROPOSAL
 encryption aes-cbc-256
 integrity sha256
 group 14
!
crypto ikev2 policy IKEv2-POLICY 
 proposal IKEv2-PROPOSAL
!
crypto ikev2 keyring IKEv2-KEYRING
 peer GW1
  address [gw-1-pip]
  pre-shared-key vpnkey123
 peer GW2
  address [gw-2-pip]
  pre-shared-key vpnkey123
!
crypto ikev2 profile IKEv2-PROFILE
 match address local interface GigabitEthernet1
 match address local interface GigabitEthernet3
 match identity remote address [gw-1-pip] 255.255.255.255
 match identity remote address [gw-2-pip] 255.255.255.255 
 authentication remote pre-share
 authentication local pre-share
 keyring local IKEv2-KEYRING
 lifetime 28800
 dpd 10 5 on-demand
!
crypto ipsec transform-set IPSEC-TRANSFORM esp-aes 256 esp-sha256-hmac 
 mode tunnel
!
crypto ipsec profile IPSEC-PROFILE
 set transform-set IPSEC-TRANSFORM 
 set ikev2-profile IKEv2-PROFILE
 set security-association lifetime kilobytes 102400000
!
interface Tunnel101
 description tunnel to Instance 0 - sourced from outside interface / public ip GigabitEthernet1
 ip address 169.254.22.1 255.255.255.252
 ip tcp adjust-mss 1350
 tunnel source GigabitEthernet1
 tunnel mode ipsec ipv4 
 tunnel destination [gw-1-pip]
 tunnel protection ipsec profile IPSEC-PROFILE
!
interface Tunnel102
 description tunnel to Instance 1 - sourced from outside interface / public ip GigabitEthernet3
 ip address 169.254.21.5 255.255.255.252
 ip tcp adjust-mss 1350
 tunnel source GigabitEthernet3
 tunnel mode ipsec ipv4 
 tunnel destination [gw-2-pip]
 tunnel protection ipsec profile IPSEC-PROFILE
!       
! default route pointing to outside subnet default gateway, so that tunnel outside traffic and internet go out LAN port
ip route 0.0.0.0 0.0.0.0 GigabitEthernet1 10.10.0.1
! route to VNET Gateway Instance1 public ip to outside interface / public ip GigabitEthernet3
ip route [gw-2-pip] 255.255.255.255 GigabitEthernet3 10.10.10.1
! route to ars subnet pointing to inside interface
ip route 10.10.4.0 255.255.255.0 GigabitEthernet2 10.10.1.1
! static routes to the APIPA tunnel subnets between the other c8k and the Gateway 
! these routes necessary because the gateway may send APIPA endpoints from the other tunnel subnets as next hops
! and these need to be recursively looked up
ip route 169.254.21.0 255.255.255.252 Tunnel101
ip route 169.254.22.4 255.255.255.252 Tunnel102

router bgp 65002
bgp log-neighbor-changes
! network statement so that vnet is advertised 
network 10.10.0.0 mask 255.255.0.0
neighbor 10.10.4.4 remote-as 65515
neighbor 10.10.4.4 ebgp-multihop 255
neighbor 10.10.4.4 soft-reconfiguration inbound
neighbor 10.10.4.5 remote-as 65515
neighbor 10.10.4.5 ebgp-multihop 255
neighbor 169.254.22.2 remote-as 65001
neighbor 169.254.22.2 ebgp-multihop 255
neighbor 169.254.22.2 update-source Tunnel101
neighbor 169.254.22.2 soft-reconfiguration inbound
neighbor 169.254.21.6 remote-as 65001
neighbor 169.254.21.6 ebgp-multihop 255
neighbor 169.254.21.6 update-source Tunnel102
neighbor 169.254.21.6 soft-reconfiguration inbound


